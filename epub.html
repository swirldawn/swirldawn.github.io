<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link crossorigin="anonymous" integrity="sha384-ZGOeC5599LBklRxQdNE29esWMd4pDZqTT5TCWhaseM5+6WUGgBWetO2pZ2AC8NoA" href="https://lib.baomitu.com/zui/1.9.2/css/zui.min.css" rel="stylesheet">
    <script   src="./epub/epub.js"></script>
    <script  src="./epub/jszip.min.js"></script>
    <!-- <script crossorigin="anonymous"  src="https://lib.baomitu.com/jszip/latest/jszip.min.js"></script> -->
    <title>Document</title>
  <style>
      .arrow{
        font-size:22px;
        width:120px;
        display:inline-block;
      }
      .box{
          margin:0 auto;
          width:1200px;
      }
      .menu{
          float:left;
      }
      body{
          background-color: #EEEEEE;
      }
      .content{float:left}
      

.list-group-item {

   
    padding: 3px 15px;
    

}
  </style>
</head>

<body>
    <div class="box col-12" >
        <div class="menu col-2">
   
            <input type="file" name="file" id="file" onchange="showEpub(this)" >选择书籍</input>
            <!-- <button onclick="prevPage()">上一页</button>
            <button onclick="nextPage()">下一页</button> -->
            <div>
                <a id="prev" href="#prev" class="arrow" >‹ 上一页</a>
                <a id="next" href="#next" class="arrow" >下一页 ›</a>
            </div>
           
            <select id="toc" ></select>
            <ul class="list-group" id="toc-list">
                <li class="list-group-item">
                  <a href="#">项目</a>
                </li>
               
              </ul>
        </div>
 
    <div id="area"  class="col-8 content"></div>
</div>
    <script>
       
let request = window.indexedDB.open('books',2);
let db

request.onerror = (event) => {
  console.log('数据库打开报错', event)
}

request.onsuccess = () => {
  db = request.result
  console.log('数据库打开成功', db)
}

request.onupgradeneeded = ({ target: { result } }) => {
  // changing objectStore data is done here, as opposed to a transaction enum:
  db = result
  console.log('数据库升级', db)
  let objStore
  // Node.contains()返回的是一个boolean，来表示传入的节点是否为该节点的后代节点。
  // 判断是否有person对象仓库 若没有则新建一个对象仓库(即新建表)
  if (!db.objectStoreNames.contains('list')) {
    /**
     * 新建person表 主键(key)是默认建立的索引，比如下面我们使用id做为主键
     * @param name: string
     * @param optionalParameters?: IDBIndexParameters
     * keyPath
     * autoIncrement
    */
     objStore = db.createObjectStore('list', { keyPath: 'id' })
    /**
     * 创建索引 用于快速检索
     * @param name: string
     * @param keyPath: string | string[]
     * @param optionalParameters?: IDBIndexParameters
    */
    // objStore.createIndex('nameIndex', 'name', { unique: false })
  }
}

function add(name,data) {
  let content = db.transaction([name], 'readwrite')
     .objectStore(name)
     .add(data);

  content.onsuccess = (event) => {
    console.log('数据写入成功')
  }

  content.onerror = (event) => {
    console.log('数据写入失败')
  }
}
function search (name, index) {
    return new Promise((result, reject) => {
      const request = db.transaction([name])
        .objectStore(name)
        .get(index)

      request.onsuccess = (event) => {
        if (request.result) {
          result(request.result)
        } else {
          console.log('no data')
          reject()
        }
      }

      request.onerror = (error) => {
        console.log('事务失败')
        reject(error)
      }
    })
  }
// function search (name,index) {
//   // 新建查询事务
//   re =null;
//   const request = db.transaction([name])
//     .objectStore(name)
//      // 查询主键是1的  
//     .get(index)
//      // 通过索引查
//      // .index('name')
//     // .get('李四')
  
//   request.onsuccess = (event) => {
//     if (request.result) {
//         console.log(request.result);
//      re = request.result;
//      return re;
//     } else {
//       console.log('未获得数据记录')
//     }
//   }
  
//   request.onerror = (event) => {
//     console.log('事务失败')
//   }
//   return re;
// }
function remove(name,index) {
  const request = db.transaction([name], 'readwrite')
    .objectStore(name)
    .delete(index)

  request.onsuccess = (event) => {
    console.log('数据删除成功')
  }

  request.onerror = (event) => {
    console.log('数据删除失败')
  }
}
    var book =null;
    var rendition = null;
    var params = URLSearchParams && new URLSearchParams(document.location.search.substring(1));
    var currentSectionIndex = (params && params.get("loc")) ? params.get("loc") : undefined;
    // document.getElementById("area").children[0].scrollHeight;//获取已看的高度
        function  showEpub(e){
                 
                //  var inputBox = document.getElementById("file");
                //  console.log(inputBox);
              var fileread = new FileReader();
              //读取文件并且将一个包含文件内容的ArrayBuffer保存咋result属性中
              fileread.readAsArrayBuffer(e.files[0]);
          

              fileread.onload = function(e){
                var bookdata = e.target.result; 
                var insertData = {id:1,data:bookdata};
                    console.log(insertData);
                    //删除之前书的进度
                    localStorage.removeItem("page");
                    //保存这本书
               add('list', insertData);
               
                
                initBook(bookdata);
                
              }
        }
                function initBook(bookdata){
                   
                    book = ePub();
                book.open(bookdata);
                    
                   
                    rendition = book.renderTo("area",{
                    width: "100%",
                    height: window.innerHeight,
                    // spread: "always",
                    flow: "scrolled-doc",//似乎是单页
                    });  
                    // console.log(rendition);
                    var page = localStorage.getItem("page");
                    page = page==null?1:page;
                    rendition.display(page);
                    
                    rendition.themes.fontSize("16px");
                    rendition.themes.font("微软雅黑");
                    //必须注册才能选择背景颜色
                    rendition.themes.register("黄色",{
                    body:{
                        color:"#2c3c6d",background:"#f1e5d5",
                    }
                    })
                    //此处可选背景颜色
                    rendition.themes.select("黄色");
                    // rendition.display();
                    //设置翻页和快捷键
                    book.ready.then(() => {

                        var next = document.getElementById("next");

                        next.addEventListener("click", function(e){
                        book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
                        localStorage.setItem("page",rendition.location.start.href);
                        e.preventDefault();
                        }, false);

                        var prev = document.getElementById("prev");
                        prev.addEventListener("click", function(e){
                        book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
                        localStorage.setItem("page",rendition.location.start.href);
                        e.preventDefault();
                        }, false);

                        var keyListener = function(e){

                        // Left Key
                        if ((e.keyCode || e.which) == 37) {
                            book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
                            localStorage.setItem("page",rendition.location.start.href);
                            // console.log();
                        }

                        // Right Key
                        if ((e.keyCode || e.which) == 39) {
                            book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
                            console.log(rendition.location.start.href );
                            localStorage.setItem("page",rendition.location.start.href);
                        }

                        };

                        rendition.on("keyup", keyListener);
                        document.addEventListener("keyup", keyListener, false);

                        })
                        //查看当前目录？
                    // rendition.on("rendered", function(section){
                    //     var current = book.navigation && book.navigation.get(section.href);
                            
                    //     if (current) {
                    //         var $select = document.getElementById("toc");
                    //         var $selected = $select.querySelector("option[selected]");
                    //         if ($selected) {
                    //         $selected.removeAttribute("selected");
                    //         }

                    //         var $options = $select.querySelectorAll("option");
                    //         for (var i = 0; i < $options.length; ++i) {
                    //         let selected = $options[i].getAttribute("ref") === current.href;
                    //         if (selected) {
                    //             $options[i].setAttribute("selected", "");
                    //         }
                    //         }
                    //     }

                    //     });
                        //渲染目录
                        book.loaded.navigation.then(function(toc){
                            var $select = document.getElementById("toc"),
                            docfrag = document.createDocumentFragment();
                            var tocList = document.getElementById("toc-list");
                            toc.forEach(function(chapter) {
                                var option = document.createElement("option");
                                option.textContent = chapter.label;
                                option.setAttribute("ref", chapter.href);

                                docfrag.appendChild(option);
                                var a = document.createElement("a");
                                a.textContent = chapter.label;
                                a.setAttribute("ref", chapter.href);
                                a.onclick = function(){
                                    url = this.getAttribute("ref");
                                    localStorage.setItem("page",url);
                                    rendition.display(url);
                                    return false;
                                }
                                var li = document.createElement("li");
                                li.className="list-group-item";
                                li.appendChild(a);
                                tocList.appendChild(li);
                            });

                            $select.appendChild(docfrag);

                            $select.onchange = function(){
                            var index = $select.selectedIndex,
                                    url = $select.options[index].getAttribute("ref");
                                    localStorage.setItem("page",url);
                            rendition.display(url);
                            return false;
                            };

                    });
                }
                setTimeout(() => {
                    // remove('list',1);
                    var book = search('list',1).then(function(data){
                            initBook(data.data);
                           
                            setTimeout(() => {
                                pagePercent =  localStorage.getItem("pagePercent");
                                if(pagePercent>0){
                                    document.getElementById("area").children[0].scrollTop=pagePercent;
                                }
                                    document.getElementById("area").children[0].onscroll =function(){
                                        var height =document.getElementById("area").children[0].scrollHeight;
                                        var current =document.getElementById("area").children[0].scrollTop;
                                        localStorage.setItem("pagePercent",current);
                                        console.log(height,current);
                                    }  
                            }, 200);
                           
                    });
                }, 400);
               
         </script>
    

  
    
</body>
<script>
     
  

// this.book = window.ePub(`西游记.epub`, {   restore: true})

// var rendition = book.renderTo("area", {width: 600, height: 400});

// var displayed = rendition.display();
</script>
</html>